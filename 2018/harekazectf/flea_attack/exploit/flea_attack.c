#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <malloc.h>
#include <string.h>

#define MAX_NAME_NUM 0x100
#define MIN_NAME_NUM 0
#define COMMENT_SIZE 0x80
#define FLAG_SIZE 0x30
char comment[COMMENT_SIZE];
char flag[FLAG_SIZE];

int gets_int() {
    char input_str[12];
    fgets(input_str, 11, stdin);
    return atoi(input_str);
}

void original_fgets(char *str, size_t size) {
    for (size_t i = 0; i < size-1; i++) {
        read(0,&str[i],1);
        switch (str[i]) {
            case '\0':
                str[i] = '\n';
            case '\n':
                str[i+1] = '\0';
                return;
        }
    }
}

void gets_comment() {
    original_fgets(comment, COMMENT_SIZE - 0x20);
}

void open_flag() {
    FILE *flag_file = fopen("/home/flea_attack/flag", "r");
    if(!flag_file) {
        puts("ERROR: Open Error");
        exit(EXIT_FAILURE);
    }
    fgets(flag, FLAG_SIZE, flag_file);
}

void show_menu() {
    puts("1. Add name");
    puts("2. Delete name");
    puts("3. Exit");
}

void add_name() {
    printf("Size: ");
    int size = gets_int();
    char *name = malloc(size);
    printf("Name: ");
    read(0, name, size);
    puts("Done!");
    printf("Name: %s\n", name);
    printf("Addr: %llx\n", (long long unsigned int)name);
}

void del_name() {
    printf("Addr: ");
    long long unsigned int addr = (long long unsigned int)NULL;
    scanf("%llx", &addr);
    free((void *)addr);
    puts("Done!");
}

int main(void) {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    open_flag();

    printf("Some comment this note:");
    gets_comment();
    while(1) {
        show_menu();
        printf("> ");
        int command = gets_int();
        switch(command) {
        case 1:
            add_name();
            break;
        case 2:
            del_name();
            break;
        case 3:
            puts("Bye.");
            exit(EXIT_SUCCESS);
            break;
        default:
            puts("Invalid");
        }
    }
    return EXIT_SUCCESS;
}
